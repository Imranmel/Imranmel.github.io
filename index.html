<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imran â€” Progress Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Slightly enlarge the calendar cells for readability */
    .calendar-cell { min-height: 90px; }
    /* Tooltip */
    .tooltip {
      position: absolute;
      z-index: 50;
      max-width: 260px;
      background: rgba(17,24,39,0.95);
      color: #e6edf3;
      border: 1px solid rgba(148,163,184,0.12);
      padding: 8px;
      border-radius: 8px;
      font-size: 0.9rem;
      box-shadow: 0 6px 18px rgba(2,6,23,0.7);
      display: none;
      white-space: normal;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen font-sans">

  <!-- LOGIN -->
  <section id="login-page" class="flex items-center justify-center h-screen">
    <div class="bg-gray-800 p-8 rounded-2xl shadow-lg w-full max-w-sm text-center">
      <h2 class="text-2xl font-bold mb-6">ðŸ”’ Login</h2>
      <input id="username" type="text" placeholder="Username" class="w-full mb-3 p-3 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
      <input id="password" type="password" placeholder="Password" class="w-full mb-5 p-3 bg-gray-700 rounded text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded font-semibold">Login</button>
      <p id="login-error" class="text-red-400 mt-3 hidden">Invalid credentials</p>
      <p class="text-gray-400 text-xs mt-3">Username: <strong>ImranM</strong> Â· Password: <strong>norisknoglory</strong></p>
    </div>
  </section>

  <!-- APP -->
  <div id="app" class="hidden max-w-6xl mx-auto p-4">

    <!-- HEADER -->
    <header class="bg-gray-800 p-4 rounded-lg mb-6 flex flex-col sm:flex-row justify-between items-center gap-3">
      <div>
        <h1 class="text-2xl font-bold">Imran â€” Progress Tracker</h1>
        <p class="text-xs text-gray-400 mt-1">School Â· Gym Â· Projects Â· Trading Â· Calendar</p>
      </div>

      <div class="flex items-center gap-2">
        <nav class="flex gap-2">
          <button id="tab-school" class="px-4 py-2 rounded bg-blue-600">School</button>
          <button id="tab-gym" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Gym</button>
          <button id="tab-projects" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Projects</button>
          <button id="tab-trading" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Trading</button>
          <button id="tab-calendar" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Calendar</button>
        </nav>

        <div class="flex items-center gap-2 ml-4">
          <div id="cumulative-pnl" class="text-sm font-medium text-gray-300">Total PnL: $0</div>
          <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded">Logout</button>
        </div>
      </div>
    </header>

    <!-- TABS CONTENT -->
    <main>
      <!-- SCHOOL TAB -->
      <section id="tab-content-school" class="">
        <div class="bg-gray-800 p-6 rounded-lg shadow mb-6">
          <div class="flex flex-col sm:flex-row gap-6">
            <div class="w-full sm:w-1/2">
              <label class="text-sm text-gray-300">Date</label>
              <input id="school-date" type="date" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>

            <div class="w-full sm:w-1/2 grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm text-gray-300">Course / Code</label>
                <input id="school-course" type="text" placeholder="CTN210, MTH110..." class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
              </div>
              <div>
                <label class="text-sm text-gray-300">Study Type</label>
                <select id="school-type" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                  <option value="">Type...</option>
                  <option>Lecture</option>
                  <option>Homework</option>
                  <option>Exam prep</option>
                  <option>Project</option>
                  <option>Lab</option>
                  <option>Reading</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Hours Studied</label>
              <input id="school-hours" type="number" step="0.25" min="0" placeholder="1.5" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Mood</label>
              <select id="school-mood" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">Mood...</option>
                <option>Focused</option>
                <option>Tired</option>
                <option>Motivated</option>
                <option>Confused</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-300">Main Topic</label>
              <input id="school-topic" type="text" placeholder="Integrals, Shear Diagrams..." class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
          </div>

          <div class="mt-4">
            <label class="text-sm text-gray-300">Notes / What you did</label>
            <textarea id="school-notes" rows="4" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="Details..."></textarea>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="save-school" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold">Save School Log</button>
            <button id="clear-school" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Clear</button>
            <p id="school-status" class="text-sm text-gray-400 self-center"></p>
          </div>
        </div>
      </section>

      <!-- GYM TAB -->
      <section id="tab-content-gym" class="hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow mb-6">
          <div class="flex flex-col sm:flex-row gap-6">
            <div class="w-full sm:w-1/2">
              <label class="text-sm text-gray-300">Date</label>
              <input id="gym-date" type="date" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>

            <div class="w-full sm:w-1/2 grid grid-cols-2 gap-2">
              <div>
                <label class="text-sm text-gray-300">Workout Type</label>
                <select id="gym-type" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                  <option value="">Type...</option>
                  <option>Push</option>
                  <option>Pull</option>
                  <option>Legs</option>
                  <option>Cardio</option>
                  <option>Mobility</option>
                  <option>Full Body</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-300">Duration (min)</label>
                <input id="gym-duration" type="number" min="0" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="60">
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Intensity (1-10)</label>
              <input id="gym-intensity" type="number" min="1" max="10" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="7">
            </div>
            <div>
              <label class="text-sm text-gray-300">Energy / Mood</label>
              <select id="gym-mood" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">Energy...</option>
                <option>High</option>
                <option>Okay</option>
                <option>Low</option>
                <option>Injured</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-300">Calories (optional)</label>
              <input id="gym-calories" type="number" min="0" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="">
            </div>
          </div>

          <div class="mt-4">
            <label class="text-sm text-gray-300">Exercises / Notes</label>
            <textarea id="gym-notes" rows="4" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="Bench 3x5, Squat 4x6..."></textarea>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="save-gym" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold">Save Gym Log</button>
            <button id="clear-gym" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Clear</button>
            <p id="gym-status" class="text-sm text-gray-400 self-center"></p>
          </div>
        </div>
      </section>

      <!-- PROJECTS TAB -->
      <section id="tab-content-projects" class="hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="text-sm text-gray-300">Date</label>
              <input id="project-date" type="date" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Project Name</label>
              <input id="project-name" type="text" placeholder="Website, Script, Research..." class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Hours Worked</label>
              <input id="project-hours" type="number" step="0.25" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="2">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Task Completed</label>
              <input id="project-task" type="text" placeholder="Fixed bug, Implemented feature..." class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Progress (%)</label>
              <input id="project-progress" type="number" min="0" max="100" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="40">
            </div>
            <div>
              <label class="text-sm text-gray-300">Mood / Productivity</label>
              <select id="project-mood" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">Select...</option>
                <option>Productive</option>
                <option>Distracted</option>
                <option>Flow</option>
                <option>Blocked</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <label class="text-sm text-gray-300">Notes</label>
            <textarea id="project-notes" rows="4" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="Details..."></textarea>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="save-project" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold">Save Project Log</button>
            <button id="clear-project" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Clear</button>
            <p id="project-status" class="text-sm text-gray-400 self-center"></p>
          </div>
        </div>
      </section>

      <!-- TRADING TAB -->
      <section id="tab-content-trading" class="hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow mb-6">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="text-sm text-gray-300">Date</label>
              <input id="trade-date" type="date" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Asset / Pair</label>
              <input id="trade-asset" type="text" placeholder="NAS100, EUR/USD..." class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
            </div>
            <div>
              <label class="text-sm text-gray-300">Position</label>
              <select id="trade-position" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">Buy / Sell</option>
                <option>Buy</option>
                <option>Sell</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Entry Price</label>
              <input id="trade-entry" type="number" step="0.0001" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="">
            </div>
            <div>
              <label class="text-sm text-gray-300">Exit Price</label>
              <input id="trade-exit" type="number" step="0.0001" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="">
            </div>
            <div>
              <label class="text-sm text-gray-300">Position Size ($)</label>
              <input id="trade-size" type="number" step="0.01" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="">
            </div>
            <div>
              <label class="text-sm text-gray-300">Profit / Loss ($)</label>
              <input id="trade-pnl" type="number" step="0.01" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="e.g. -50 or 120">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="text-sm text-gray-300">Setup Type</label>
              <select id="trade-setup" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">Setup...</option>
                <option>Breakout</option>
                <option>Pullback</option>
                <option>Mean reversion</option>
                <option>News</option>
                <option>Scalp</option>
              </select>
            </div>
            <div>
              <label class="text-sm text-gray-300">Risk ($)</label>
              <input id="trade-risk" type="number" step="0.01" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="">
            </div>
            <div>
              <label class="text-sm text-gray-300">Emotion</label>
              <select id="trade-emotion" class="w-full mt-1 p-2 rounded bg-gray-700 text-white">
                <option value="">How you felt...</option>
                <option>Calm</option>
                <option>Anxious</option>
                <option>Confident</option>
                <option>Greedy</option>
                <option>Afraid</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <label class="text-sm text-gray-300">Notes / Reason</label>
            <textarea id="trade-notes" rows="4" class="w-full mt-1 p-2 rounded bg-gray-700 text-white" placeholder="Why you took the trade, lessons..."></textarea>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="save-trade" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold">Save Trade Log</button>
            <button id="clear-trade" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Clear</button>
            <p id="trade-status" class="text-sm text-gray-400 self-center"></p>
          </div>

          <!-- Trading summary snapshot -->
          <div class="mt-6 bg-gray-900 border border-gray-700 p-4 rounded">
            <h4 class="text-sm text-gray-300 mb-2">Trading snapshot</h4>
            <div class="grid grid-cols-2 gap-4 text-sm text-gray-200">
              <div>Total Trades: <span id="summary-total-trades">0</span></div>
              <div>Winning Trades: <span id="summary-wins">0</span></div>
              <div>Losing Trades: <span id="summary-losses">0</span></div>
              <div>Total PnL: <span id="summary-pnl">0</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CALENDAR TAB -->
      <section id="tab-content-calendar" class="hidden">
        <div class="bg-gray-800 p-4 rounded-lg shadow mb-6">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-2">
              <button id="cal-prev" class="p-2 rounded bg-gray-700 hover:bg-gray-600">â—€</button>
              <h2 id="calendar-month" class="text-xl font-semibold"></h2>
              <button id="cal-next" class="p-2 rounded bg-gray-700 hover:bg-gray-600">â–¶</button>
            </div>

            <div class="flex gap-2 items-center text-xs text-gray-300">
              <span class="inline-flex items-center gap-1"><span class="w-3 h-3 bg-blue-400 rounded-full"></span> School</span>
              <span class="inline-flex items-center gap-1"><span class="w-3 h-3 bg-orange-400 rounded-full"></span> Gym</span>
              <span class="inline-flex items-center gap-1"><span class="w-3 h-3 bg-purple-400 rounded-full"></span> Project</span>
              <span class="inline-flex items-center gap-1"><span class="w-3 h-3 bg-green-400 rounded-full"></span> Trading Profit</span>
              <span class="inline-flex items-center gap-1"><span class="w-3 h-3 bg-red-400 rounded-full"></span> Trading Loss</span>
            </div>
          </div>

          <!-- larger calendar -->
          <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-sm"></div>
        </div>
      </section>
    </main>

    <!-- DAY DETAILS MODAL -->
    <div id="day-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div class="bg-gray-800 w-full max-w-2xl p-6 rounded-lg relative">
        <button id="close-day-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">âœ•</button>
        <h3 id="detail-date" class="text-lg font-semibold mb-3"></h3>

        <div id="detail-content" class="space-y-4 text-sm max-h-[60vh] overflow-y-auto pr-2">
          <!-- Content filled dynamically -->
        </div>

        <div class="mt-4 flex justify-between items-center">
          <div class="text-xs text-gray-400">Tip: Use "Delete Log" to remove this day's entry.</div>
          <div class="flex gap-2">
            <button id="delete-log-btn" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded">Delete Log</button>
            <button id="close-day-modal-2" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tooltip element -->
    <div id="tooltip" class="tooltip"></div>

  </div>

  <script>
    /* -----------------------
       App constants & helpers
       ----------------------- */
    const USERNAME = 'ImranM';
    const PASSWORD = 'norisknoglory';
    const LS_KEY = 'imran_daily_logs_v3';

    const app = document.getElementById('app');
    const loginPage = document.getElementById('login-page');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginError = document.getElementById('login-error');

    const state = {
      currentDate: new Date(),
      logs: JSON.parse(localStorage.getItem(LS_KEY) || '{}')
    };

    // Utilities
    const formatDate = d => new Date(d).toISOString().split('T')[0];
    const todayStr = formatDate(new Date());
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    /* -----------------------
       Login logic
       ----------------------- */
    if (localStorage.getItem('imran_logged_in') === 'true') showApp();
    loginBtn.onclick = () => {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if (u === USERNAME && p === PASSWORD) {
        localStorage.setItem('imran_logged_in', 'true');
        showApp();
      } else {
        loginError.classList.remove('hidden');
        setTimeout(()=>loginError.classList.add('hidden'), 2500);
      }
    };
    logoutBtn.onclick = () => {
      localStorage.removeItem('imran_logged_in');
      hideApp();
    };
    function showApp() {
      loginPage.classList.add('hidden');
      app.classList.remove('hidden');
      initializeUI();
      refreshAll();
    }
    function hideApp() {
      app.classList.add('hidden');
      loginPage.classList.remove('hidden');
    }

    /* -----------------------
       UI element references
       ----------------------- */
    const tabs = {
      schoolBtn: document.getElementById('tab-school'),
      gymBtn: document.getElementById('tab-gym'),
      projectsBtn: document.getElementById('tab-projects'),
      tradingBtn: document.getElementById('tab-trading'),
      calendarBtn: document.getElementById('tab-calendar'),
      schoolSection: document.getElementById('tab-content-school'),
      gymSection: document.getElementById('tab-content-gym'),
      projectsSection: document.getElementById('tab-content-projects'),
      tradingSection: document.getElementById('tab-content-trading'),
      calendarSection: document.getElementById('tab-content-calendar')
    };

    const cumulativePnlEl = document.getElementById('cumulative-pnl');

    // School controls
    const schoolDate = document.getElementById('school-date');
    const schoolCourse = document.getElementById('school-course');
    const schoolType = document.getElementById('school-type');
    const schoolHours = document.getElementById('school-hours');
    const schoolMood = document.getElementById('school-mood');
    const schoolTopic = document.getElementById('school-topic');
    const schoolNotes = document.getElementById('school-notes');
    const saveSchoolBtn = document.getElementById('save-school');
    const clearSchoolBtn = document.getElementById('clear-school');
    const schoolStatus = document.getElementById('school-status');

    // Gym controls
    const gymDate = document.getElementById('gym-date');
    const gymType = document.getElementById('gym-type');
    const gymDuration = document.getElementById('gym-duration');
    const gymIntensity = document.getElementById('gym-intensity');
    const gymMood = document.getElementById('gym-mood');
    const gymCalories = document.getElementById('gym-calories');
    const gymNotes = document.getElementById('gym-notes');
    const saveGymBtn = document.getElementById('save-gym');
    const clearGymBtn = document.getElementById('clear-gym');
    const gymStatus = document.getElementById('gym-status');

    // Projects controls
    const projectDate = document.getElementById('project-date');
    const projectName = document.getElementById('project-name');
    const projectHours = document.getElementById('project-hours');
    const projectTask = document.getElementById('project-task');
    const projectProgress = document.getElementById('project-progress');
    const projectMood = document.getElementById('project-mood');
    const projectNotes = document.getElementById('project-notes');
    const saveProjectBtn = document.getElementById('save-project');
    const clearProjectBtn = document.getElementById('clear-project');
    const projectStatus = document.getElementById('project-status');

    // Trading controls
    const tradeDate = document.getElementById('trade-date');
    const tradeAsset = document.getElementById('trade-asset');
    const tradePosition = document.getElementById('trade-position');
    const tradeEntry = document.getElementById('trade-entry');
    const tradeExit = document.getElementById('trade-exit');
    const tradeSize = document.getElementById('trade-size');
    const tradePnl = document.getElementById('trade-pnl');
    const tradeSetup = document.getElementById('trade-setup');
    const tradeRisk = document.getElementById('trade-risk');
    const tradeEmotion = document.getElementById('trade-emotion');
    const tradeNotes = document.getElementById('trade-notes');
    const saveTradeBtn = document.getElementById('save-trade');
    const clearTradeBtn = document.getElementById('clear-trade');
    const tradeStatus = document.getElementById('trade-status');

    // Trading summary elements
    const summaryTotalTrades = document.getElementById('summary-total-trades');
    const summaryWins = document.getElementById('summary-wins');
    const summaryLosses = document.getElementById('summary-losses');
    const summaryPnl = document.getElementById('summary-pnl');

    // Calendar controls
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonth = document.getElementById('calendar-month');
    const calPrev = document.getElementById('cal-prev');
    const calNext = document.getElementById('cal-next');

    // Day modal & tooltip
    const dayModal = document.getElementById('day-modal');
    const detailDate = document.getElementById('detail-date');
    const detailContent = document.getElementById('detail-content');
    const closeDayModal = document.getElementById('close-day-modal');
    const closeDayModal2 = document.getElementById('close-day-modal-2');
    const deleteLogBtn = document.getElementById('delete-log-btn');
    const tooltip = document.getElementById('tooltip');

    /* -----------------------
       Initialize UI, events
       ----------------------- */
    function initializeUI() {
      // Set default dates
      schoolDate.value = todayStr;
      gymDate.value = todayStr;
      projectDate.value = todayStr;
      tradeDate.value = todayStr;

      // Tab navigation
      Object.entries({
        tabSchool: { btn: tabs.schoolBtn, section: tabs.schoolSection },
        tabGym: { btn: tabs.gymBtn, section: tabs.gymSection },
        tabProjects: { btn: tabs.projectsBtn, section: tabs.projectsSection },
        tabTrading: { btn: tabs.tradingBtn, section: tabs.tradingSection },
        tabCalendar: { btn: tabs.calendarBtn, section: tabs.calendarSection }
      }).forEach(([k, v], idx) => {
        v.btn.addEventListener('click', () => {
          // hide all
          tabs.schoolSection.classList.add('hidden');
          tabs.gymSection.classList.add('hidden');
          tabs.projectsSection.classList.add('hidden');
          tabs.tradingSection.classList.add('hidden');
          tabs.calendarSection.classList.add('hidden');
          // remove active backgrounds
          tabs.schoolBtn.classList.remove('bg-blue-600');
          tabs.gymBtn.classList.remove('bg-blue-600');
          tabs.projectsBtn.classList.remove('bg-blue-600');
          tabs.tradingBtn.classList.remove('bg-blue-600');
          tabs.calendarBtn.classList.remove('bg-blue-600');

          // show clicked
          v.section.classList.remove('hidden');
          v.btn.classList.add('bg-blue-600');

          if (v.section === tabs.calendarSection) renderCalendar();
        });
      });

      // Default tab
      tabs.schoolBtn.click();

      // Save / clear handlers
      saveSchoolBtn.onclick = saveSchool;
      clearSchoolBtn.onclick = () => { schoolCourse.value = ''; schoolType.value = ''; schoolHours.value = ''; schoolMood.value = ''; schoolTopic.value = ''; schoolNotes.value = ''; };

      saveGymBtn.onclick = saveGym;
      clearGymBtn.onclick = () => { gymType.value=''; gymDuration.value=''; gymIntensity.value=''; gymMood.value=''; gymCalories.value=''; gymNotes.value=''; };

      saveProjectBtn.onclick = saveProject;
      clearProjectBtn.onclick = () => { projectName.value=''; projectHours.value=''; projectTask.value=''; projectProgress.value=''; projectMood.value=''; projectNotes.value=''; };

      saveTradeBtn.onclick = saveTrade;
      clearTradeBtn.onclick = () => { tradeAsset.value=''; tradePosition.value=''; tradeEntry.value=''; tradeExit.value=''; tradeSize.value=''; tradePnl.value=''; tradeSetup.value=''; tradeRisk.value=''; tradeEmotion.value=''; tradeNotes.value=''; };

      // Calendar navigation
      calPrev.onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); };
      calNext.onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); };

      // Modal controls
      closeDayModal.onclick = closeDayModalHandler;
      closeDayModal2.onclick = closeDayModalHandler;
      deleteLogBtn.onclick = handleDeleteLog;

      // tooltip hide on mouseout of window
      document.addEventListener('scroll', () => tooltip.style.display = 'none');
    }

    /* -----------------------
       Save handlers
       ----------------------- */
    function saveSchool() {
      const date = schoolDate.value || todayStr;
      const entry = (state.logs[date] || createEmptyDay());
      entry.school = {
        course: schoolCourse.value.trim(),
        type: schoolType.value.trim(),
        hours: parseFloat(schoolHours.value) || 0,
        mood: schoolMood.value,
        topic: schoolTopic.value.trim(),
        notes: schoolNotes.value.trim()
      };
      entry.summary = generateSummary(entry);
      state.logs[date] = entry;
      persist();
      schoolStatus.textContent = `Saved (${date})`;
      setTimeout(()=>schoolStatus.textContent = '', 1600);
      // clear school inputs
      // do NOT clear date so next entry for same day is easy
      schoolCourse.value = ''; schoolType.value = ''; schoolHours.value = ''; schoolMood.value = ''; schoolTopic.value = ''; schoolNotes.value = '';
      renderCalendar();
      refreshAll();
    }

    function saveGym() {
      const date = gymDate.value || todayStr;
      const entry = (state.logs[date] || createEmptyDay());
      entry.gym = {
        type: gymType.value,
        duration: parseFloat(gymDuration.value) || 0,
        intensity: parseInt(gymIntensity.value) || null,
        energy: gymMood.value,
        calories: parseFloat(gymCalories.value) || null,
        notes: gymNotes.value.trim()
      };
      entry.summary = generateSummary(entry);
      state.logs[date] = entry;
      persist();
      gymStatus.textContent = `Saved (${date})`;
      setTimeout(()=>gymStatus.textContent = '', 1600);
      gymType.value=''; gymDuration.value=''; gymIntensity.value=''; gymMood.value=''; gymCalories.value=''; gymNotes.value='';
      renderCalendar();
      refreshAll();
    }

    function saveProject() {
      const date = projectDate.value || todayStr;
      const entry = (state.logs[date] || createEmptyDay());
      entry.project = {
        name: projectName.value.trim(),
        hours: parseFloat(projectHours.value) || 0,
        task: projectTask.value.trim(),
        progress: clamp(parseInt(projectProgress.value) || 0, 0, 100),
        mood: projectMood.value,
        notes: projectNotes.value.trim()
      };
      entry.summary = generateSummary(entry);
      state.logs[date] = entry;
      persist();
      projectStatus.textContent = `Saved (${date})`;
      setTimeout(()=>projectStatus.textContent = '', 1600);
      projectName.value=''; projectHours.value=''; projectTask.value=''; projectProgress.value=''; projectMood.value=''; projectNotes.value='';
      renderCalendar();
      refreshAll();
    }

    function saveTrade() {
      const date = tradeDate.value || todayStr;
      const entry = (state.logs[date] || createEmptyDay());
      entry.trading = {
        asset: tradeAsset.value.trim(),
        position: tradePosition.value,
        entry: tradeEntry.value ? parseFloat(tradeEntry.value) : null,
        exit: tradeExit.value ? parseFloat(tradeExit.value) : null,
        size: tradeSize.value ? parseFloat(tradeSize.value) : null,
        pnl: tradePnl.value ? parseFloat(tradePnl.value) : 0,
        setup: tradeSetup.value,
        risk: tradeRisk.value ? parseFloat(tradeRisk.value) : null,
        emotion: tradeEmotion.value,
        notes: tradeNotes.value.trim()
      };
      entry.summary = generateSummary(entry);
      state.logs[date] = entry;
      persist();
      tradeStatus.textContent = `Saved (${date})`;
      setTimeout(()=>tradeStatus.textContent = '', 1600);
      tradeAsset.value=''; tradePosition.value=''; tradeEntry.value=''; tradeExit.value=''; tradeSize.value=''; tradePnl.value=''; tradeSetup.value=''; tradeRisk.value=''; tradeEmotion.value=''; tradeNotes.value='';
      renderCalendar();
      refreshAll();
    }

    function createEmptyDay() {
      return { school: null, gym: null, project: null, trading: null, summary: '' };
    }

    function persist() {
      localStorage.setItem(LS_KEY, JSON.stringify(state.logs));
    }

    /* -----------------------
       Summary generator
       ----------------------- */
    function generateSummary(day) {
      // Compose a short, positive summary combining categories
      const parts = [];
      if (day.school && (day.school.course || day.school.hours || day.school.topic || day.school.notes)) {
        const hrs = day.school.hours ? `${day.school.hours}h` : '';
        const course = day.school.course ? `${day.school.course}` : '';
        const topic = day.school.topic ? `(${day.school.topic})` : '';
        parts.push(`Studied ${course} ${topic} ${hrs}`.trim());
      }
      if (day.gym && (day.gym.type || day.gym.duration || day.gym.notes)) {
        const dur = day.gym.duration ? `${day.gym.duration}min` : '';
        parts.push(`${day.gym.type || 'Workout'} ${dur}`.trim());
      }
      if (day.project && (day.project.name || day.project.task)) {
        const nm = day.project.name ? `${day.project.name}` : 'Project';
        const prog = typeof day.project.progress === 'number' ? `(${day.project.progress}%)` : '';
        parts.push(`Worked on ${nm} ${prog}`.trim());
      }
      if (day.trading && day.trading.asset) {
        const pnl = (typeof day.trading.pnl === 'number') ? `${day.trading.pnl >= 0 ? '+' : ''}${day.trading.pnl}$` : '';
        parts.push(`${day.trading.asset}: ${pnl}`);
      }
      if (parts.length === 0) return 'No activity logged.';
      // join nicely
      return parts.join(' Â· ');
    }

    /* -----------------------
       Calendar rendering
       ----------------------- */
    function renderCalendar() {
      calendarGrid.innerHTML = '';
      const d = new Date(state.currentDate.getTime());
      d.setDate(1);
      const month = d.getMonth();
      const year = d.getFullYear();
      calendarMonth.textContent = d.toLocaleString('default', { month: 'long', year: 'numeric' });

      // Weekday headers
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      for (const wd of weekdays) {
        const hd = document.createElement('div');
        hd.textContent = wd;
        hd.className = 'text-gray-400 text-xs text-center';
        calendarGrid.appendChild(hd);
      }

      const firstDayIndex = d.getDay();
      for (let i = 0; i < firstDayIndex; i++) {
        const empty = document.createElement('div');
        calendarGrid.appendChild(empty);
      }

      const daysInMonth = new Date(year, month + 1, 0).getDate();
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(year, month, day);
        const dateStr = formatDate(dateObj);

        const cell = document.createElement('div');
        cell.className = 'calendar-cell p-3 border border-gray-700 rounded-md relative hover:bg-gray-800 cursor-pointer';
        // day number
        const dayNum = document.createElement('div');
        dayNum.textContent = day;
        dayNum.className = 'font-medium';
        cell.appendChild(dayNum);

        // Small stacked markers
        const markers = document.createElement('div');
        markers.className = 'absolute right-2 bottom-2 flex gap-1';
        const log = state.logs[dateStr];

        if (log) {
          // School marker
          if (log.school && (log.school.course || log.school.hours || log.school.notes)) {
            const s = document.createElement('span');
            s.className = 'w-3 h-3 rounded-full bg-blue-400';
            s.title = 'School activity';
            markers.appendChild(s);
          }
          // Gym
          if (log.gym && (log.gym.type || log.gym.duration || log.gym.notes)) {
            const g = document.createElement('span');
            g.className = 'w-3 h-3 rounded-full bg-orange-400';
            g.title = 'Gym activity';
            markers.appendChild(g);
          }
          // Project
          if (log.project && (log.project.name || log.project.task)) {
            const p = document.createElement('span');
            p.className = 'w-3 h-3 rounded-full bg-purple-400';
            p.title = 'Project activity';
            markers.appendChild(p);
          }
          // Trading
          if (log.trading && typeof log.trading.pnl === 'number') {
            const t = document.createElement('span');
            t.className = log.trading.pnl >= 0 ? 'w-3 h-3 rounded-full bg-green-400' : 'w-3 h-3 rounded-full bg-red-400';
            t.title = `Trading: ${log.trading.pnl >= 0 ? '+' : ''}${log.trading.pnl}$`;
            markers.appendChild(t);
          }

          // Tooltip on hover with summary
          if (log.summary) {
            cell.addEventListener('mouseenter', (ev) => {
              tooltip.style.display = 'block';
              tooltip.innerHTML = `<strong>${dateStr}</strong><div style="margin-top:6px">${escapeHtml(log.summary)}</div>`;
              // position tooltip near cursor but inside viewport
              const x = ev.clientX + 12;
              const y = ev.clientY + 12;
              tooltip.style.left = Math.min(window.innerWidth - 280, x) + 'px';
              tooltip.style.top = Math.min(window.innerHeight - 120, y) + 'px';
            });
            cell.addEventListener('mousemove', (ev) => {
              const x = ev.clientX + 12;
              const y = ev.clientY + 12;
              tooltip.style.left = Math.min(window.innerWidth - 280, x) + 'px';
              tooltip.style.top = Math.min(window.innerHeight - 120, y) + 'px';
            });
            cell.addEventListener('mouseleave', () => {
              tooltip.style.display = 'none';
            });
          }
        }

        cell.appendChild(markers);

        // click -> open modal with details
        cell.addEventListener('click', () => {
          if (state.logs[dateStr]) {
            openDayModal(dateStr);
          }
        });

        calendarGrid.appendChild(cell);
      }
    }

    /* -----------------------
       Day modal functions
       ----------------------- */
    let currentModalDate = null;
    function openDayModal(dateStr) {
      currentModalDate = dateStr;
      const log = state.logs[dateStr];
      detailDate.textContent = `Details â€” ${dateStr}`;
      detailContent.innerHTML = ''; // build content

      // Daily summary header
      const sumEl = document.createElement('div');
      sumEl.className = 'bg-gray-900 border border-gray-700 p-3 rounded';
      sumEl.innerHTML = `<strong>Summary:</strong> <div class="text-sm text-gray-200 mt-2">${escapeHtml(log.summary || 'No summary.')}</div>`;
      detailContent.appendChild(sumEl);

      // School block
      if (log.school && (log.school.course || log.school.hours || log.school.notes)) {
        const block = document.createElement('div');
        block.className = 'bg-gray-900 border border-blue-700 p-3 rounded';
        block.innerHTML = `<div class="text-sm font-medium text-blue-300">School</div>
          <div class="text-sm mt-1"><strong>Course:</strong> ${escapeHtml(log.school.course || 'â€”')}</div>
          <div class="text-sm"><strong>Type:</strong> ${escapeHtml(log.school.type || 'â€”')}</div>
          <div class="text-sm"><strong>Hours:</strong> ${log.school.hours || 0}</div>
          <div class="text-sm mt-1">${escapeHtml(log.school.topic || '')}</div>
          <div class="text-sm mt-2 whitespace-pre-wrap">${escapeHtml(log.school.notes || '')}</div>
        `;
        detailContent.appendChild(block);
      }

      // Gym block
      if (log.gym && (log.gym.type || log.gym.duration || log.gym.notes)) {
        const block = document.createElement('div');
        block.className = 'bg-gray-900 border border-orange-700 p-3 rounded';
        block.innerHTML = `<div class="text-sm font-medium text-orange-300">Gym</div>
          <div class="text-sm mt-1"><strong>Type:</strong> ${escapeHtml(log.gym.type || 'â€”')}</div>
          <div class="text-sm"><strong>Duration:</strong> ${log.gym.duration || 0} min</div>
          <div class="text-sm"><strong>Intensity:</strong> ${log.gym.intensity || 'â€”'}</div>
          <div class="text-sm mt-2 whitespace-pre-wrap">${escapeHtml(log.gym.notes || '')}</div>
        `;
        detailContent.appendChild(block);
      }

      // Project block
      if (log.project && (log.project.name || log.project.task)) {
        const block = document.createElement('div');
        block.className = 'bg-gray-900 border border-purple-700 p-3 rounded';
        block.innerHTML = `<div class="text-sm font-medium text-purple-300">Project</div>
          <div class="text-sm mt-1"><strong>Project:</strong> ${escapeHtml(log.project.name || 'â€”')}</div>
          <div class="text-sm"><strong>Task:</strong> ${escapeHtml(log.project.task || 'â€”')}</div>
          <div class="text-sm"><strong>Hours:</strong> ${log.project.hours || 0}</div>
          <div class="text-sm"><strong>Progress:</strong> ${log.project.progress ?? 'â€”'}%</div>
          <div class="text-sm mt-2 whitespace-pre-wrap">${escapeHtml(log.project.notes || '')}</div>
        `;
        detailContent.appendChild(block);
      }

      // Trading block
      if (log.trading && log.trading.asset) {
        const pnlClass = log.trading.pnl >= 0 ? 'text-green-400' : 'text-red-400';
        const block = document.createElement('div');
        block.className = 'bg-gray-900 border border-green-700 p-3 rounded';
        block.innerHTML = `<div class="text-sm font-medium text-green-300">Trading</div>
          <div class="text-sm mt-1"><strong>Asset:</strong> ${escapeHtml(log.trading.asset || 'â€”')} <strong>(${escapeHtml(log.trading.position || '')})</strong></div>
          <div class="text-sm"><strong>Entry:</strong> ${log.trading.entry ?? '-'} | <strong>Exit:</strong> ${log.trading.exit ?? '-'}</div>
          <div class="text-sm"><strong>Size:</strong> ${log.trading.size ?? '-'} | <strong>Risk:</strong> ${log.trading.risk ?? '-'}</div>
          <div class="text-sm"><strong>PnL:</strong> <span class="${pnlClass}">${log.trading.pnl >= 0 ? '+' : ''}${log.trading.pnl}$</span></div>
          <div class="text-sm mt-2 whitespace-pre-wrap"><strong>Setup:</strong> ${escapeHtml(log.trading.setup || '')}<br><strong>Emotion/Notes:</strong> ${escapeHtml(log.trading.notes || '')}</div>
        `;
        detailContent.appendChild(block);
      }

      dayModal.classList.remove('hidden');
    }

    function closeDayModalHandler() {
      dayModal.classList.add('hidden');
      currentModalDate = null;
    }

    // Delete current day log (with confirm)
    function handleDeleteLog() {
      if (!currentModalDate) return;
      const confirmed = confirm(`Delete the log for ${currentModalDate}? This action cannot be undone.`);
      if (!confirmed) return;
      delete state.logs[currentModalDate];
      persist();
      renderCalendar();
      refreshAll();
      closeDayModalHandler();
    }

    /* -----------------------
       Summary & aggregations
       ----------------------- */
    function refreshAll() {
      // Recompute cumulative PnL and trading summary
      let totalPnl = 0;
      let totalTrades = 0;
      let wins = 0, losses = 0;
      for (const [d, log] of Object.entries(state.logs)) {
        if (log.trading && typeof log.trading.pnl === 'number') {
          totalTrades++;
          totalPnl += log.trading.pnl;
          if (log.trading.pnl > 0) wins++; else if (log.trading.pnl < 0) losses++;
        }
      }
      cumulativePnlEl.textContent = `Total PnL: $${round2(totalPnl)}`;
      summaryTotalTrades.textContent = totalTrades;
      summaryWins.textContent = wins;
      summaryLosses.textContent = losses;
      summaryPnl.textContent = `$${round2(totalPnl)}`;
      // color the cumulative pnl element green or red
      cumulativePnlEl.classList.remove('text-green-400', 'text-red-400');
      if (totalPnl > 0) cumulativePnlEl.classList.add('text-green-400'); else if (totalPnl < 0) cumulativePnlEl.classList.add('text-red-400'); else cumulativePnlEl.classList.add('text-gray-300');
    }

    function round2(n) { return Math.round((n + Number.EPSILON) * 100) / 100; }

    /* -----------------------
       Helpers
       ----------------------- */
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\n/g, '<br>');
    }

    /* -----------------------
       Init & render once
       ----------------------- */
    function initialize() {
      // Ensure state has map
      if (!state.logs) state.logs = {};
      renderCalendar();
      refreshAll();
    }

    function refreshLocalAndUI() {
      persist();
      renderCalendar();
      refreshAll();
    }

    // ensure UI is initialized on show
    function refreshAllAndRender() {
      renderCalendar();
      refreshAll();
    }

    // initial call
    function refreshAll() {
      // duplicate function name protection: use wrapper
      refreshAll_inner();
    }
    function refreshAll_inner() {
      // compute totals as above
      let totalPnl = 0;
      let totalTrades = 0;
      let wins = 0, losses = 0;
      for (const [d, log] of Object.entries(state.logs)) {
        if (log.trading && typeof log.trading.pnl === 'number') {
          totalTrades++;
          totalPnl += log.trading.pnl;
          if (log.trading.pnl > 0) wins++; else if (log.trading.pnl < 0) losses++;
        }
      }
      cumulativePnlEl.textContent = `Total PnL: $${round2(totalPnl)}`;
      summaryTotalTrades.textContent = totalTrades;
      summaryWins.textContent = wins;
      summaryLosses.textContent = losses;
      summaryPnl.textContent = `$${round2(totalPnl)}`;

      cumulativePnlEl.classList.remove('text-green-400', 'text-red-400');
      if (totalPnl > 0) cumulativePnlEl.classList.add('text-green-400'); else if (totalPnl < 0) cumulativePnlEl.classList.add('text-red-400'); else cumulativePnlEl.classList.add('text-gray-300');
    }

    // Kickoff initialize
    initialize();

    // Expose save functions to be sure they exist
    window.saveSchool = saveSchool;
    window.saveGym = saveGym;
    window.saveProject = saveProject;
    window.saveTrade = saveTrade;

  </script>
</body>
</html>
